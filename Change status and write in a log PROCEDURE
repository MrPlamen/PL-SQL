CREATE OR REPLACE PROCEDURE sp_SECRET_status(p_user_id IN VARCHAR2, p_acc IN VARCHAR2)

AS

    ex1 EXCEPTION;

    l_err VARCHAR2(1000) := 'NO SUCH ACCOUNT OR OTHERS';

BEGIN

    BEGIN

        IF p_acc IS NULL THEN

            l_err := 'ACCOUNT IS NULL';

            INSERT INTO MYUSER.FIB_IT_SECRET_LOG

            VALUES (SYSDATE, p_user_id, p_acc, l_err);

            COMMIT;

            RAISE ex1;

        ELSE

         

            UPDATE SCHEME.MySECRETtable

            SET AC_STAT_DORMANT = 'N'

            WHERE cust_ac_no = p_acc;

 

            IF SQL%ROWCOUNT > 1 THEN

             

                ROLLBACK;

                l_err := 'NUMBER OF RECORDS IS MORE THAN ONE';

                RAISE ex1;

               

            ELSIF SQL%ROWCOUNT < 1 THEN

             

                RAISE ex1;

                RETURN;

               

            ELSE     

              

                ROLLBACK;

             

                UPDATE SCHEME.MySECRETtable

                SET AC_STAT_DORMANT = 'N'

                WHERE cust_ac_no = p_acc

                AND AC_STAT_DORMANT = 'Y';

               

                IF SQL%ROWCOUNT < 1 THEN

                   ROLLBACK; 

                   l_err := 'THE ACCOUNT IS ALREADY NOT DORMANT';     

                   RAISE ex1;                  

                END IF;

             

            END IF;

           

        END IF;

 

        INSERT INTO MYUSER.FIB_IT_SECRET_LOG

        VALUES (SYSDATE, p_user_id, p_acc, 'SUCCESS');

        COMMIT;

 

    EXCEPTION

        WHEN OTHERS THEN

            ROLLBACK;

            INSERT INTO MYUSER.FIB_IT_SECRET_LOG

            VALUES (SYSDATE, p_user_id, p_acc, 'FAILED: ' || l_err);

            COMMIT;

            RAISE ex1;

    END;

 

    EXCEPTION

        WHEN ex1 THEN

            ROLLBACK;

END sp_remove_SECRET_status;
